<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiber Network Manager V7</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .diagram-scroll { cursor: grab; }
        .diagram-scroll:active { cursor: grabbing; }
        .equipment-box { transition: all 0.2s ease; }
        /* Highlighting for Link Mode */
        .link-mode .equipment-box:hover {
            stroke: #2563eb;
            stroke-width: 3px;
            fill: #eff6ff;
            cursor: crosshair;
        }
        .link-mode-active { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Trash2, Download, Upload, Network, Eye, Shuffle, ArrowRightLeft, Link as LinkIcon, X, Save } from 'lucide-react';

        // --- MODAL COMPONENT ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                            <X className="w-5 h-5" />
                        </button>
                        <h3 className="text-xl font-bold mb-4 text-slate-800">{title}</h3>
                        {children}
                    </div>
                </div>
            );
        };

        const FiberNetworkManager = () => {
          const [rooms, setRooms] = useState([]);
          const [equipment, setEquipment] = useState([]);
          const [connections, setConnections] = useState([]);
          const [changeLog, setChangeLog] = useState([]);
          
          // UI States
          const [activeTab, setActiveTab] = useState('rooms');
          const [showDiagram, setShowDiagram] = useState(false);
          const [autoLayout, setAutoLayout] = useState(true);
          
          // Interactive Diagram States
          const [editingConnection, setEditingConnection] = useState(null); 
          const [linkMode, setLinkMode] = useState(false); 
          const [linkSource, setLinkSource] = useState(null); 

          // Form states
          const [newRoom, setNewRoom] = useState({ name: '', description: '' });
          const [newEquipment, setNewEquipment] = useState({ name: '', type: 'laser', room: '', description: '' });
          const [newConnection, setNewConnection] = useState({
            labelFrom: '', labelTo: '', fromEquipment: '', toEquipment: '', fiberType: 'single-mode', length: '', notes: ''
          });

          const equipmentTypes = ['laser', 'multiplexer', 'amplifier', 'white-rabbit', 'connection-box', 'splitter', 'user-device', 'other'];

          // --- CRUD Actions ---

          const addRoom = () => {
            if (newRoom.name.trim()) {
              const room = { id: Date.now(), ...newRoom, createdAt: new Date().toISOString() };
              setRooms([...rooms, room]);
              logChange('add', 'room', room.name);
              setNewRoom({ name: '', description: '' });
            }
          };

          const addEquipment = () => {
            if (newEquipment.name.trim() && newEquipment.room) {
              const equip = { id: Date.now(), ...newEquipment, createdAt: new Date().toISOString() };
              setEquipment([...equipment, equip]);
              logChange('add', 'equipment', equip.name);
              setNewEquipment({ name: '', type: 'laser', room: '', description: '' });
            }
          };

          const addConnection = () => {
            if (newConnection.fromEquipment && newConnection.toEquipment) {
              const conn = { id: Date.now(), ...newConnection, createdAt: new Date().toISOString() };
              setConnections([...connections, conn]);
              
              const logName = (newConnection.labelFrom || newConnection.labelTo) 
                ? `${newConnection.labelFrom}->${newConnection.labelTo}`
                : `Unlabeled (${newConnection.fromEquipment}->${newConnection.toEquipment})`;
              logChange('add', 'connection', logName);
              
              setNewConnection({ labelFrom: '', labelTo: '', fromEquipment: '', toEquipment: '', fiberType: 'single-mode', length: '', notes: '' });
            }
          };

          const updateConnection = () => {
              if (editingConnection) {
                  setConnections(connections.map(c => c.id === editingConnection.id ? editingConnection : c));
                  logChange('update', 'connection', editingConnection.id);
                  setEditingConnection(null);
              }
          }

          const deleteItem = (type, id, name) => {
            if (type === 'room') {
              setRooms(rooms.filter(r => r.id !== id));
              setEquipment(equipment.filter(e => e.room !== id.toString()));
            } else if (type === 'equipment') {
              setEquipment(equipment.filter(e => e.id !== id));
              setConnections(connections.filter(c => c.fromEquipment !== id.toString() && c.toEquipment !== id.toString()));
            } else if (type === 'connection') {
              setConnections(connections.filter(c => c.id !== id));
              if (editingConnection && editingConnection.id === id) setEditingConnection(null);
            }
            logChange('delete', type, name);
          };

          const logChange = (action, type, item) => {
            setChangeLog([{ id: Date.now(), timestamp: new Date().toISOString(), action, type, item }, ...changeLog]);
          };

          // --- Diagram Interactions ---

          const handleEquipmentClick = (equipId) => {
              if (!linkMode) return;

              if (!linkSource) {
                  // First click: Select Source
                  setLinkSource(equipId);
              } else {
                  // Second click: Select Destination
                  if (linkSource === equipId) {
                      setLinkSource(null); // Cancel if clicked same
                  } else {
                      // IMMEDIATE ACTION: Create connection and open Edit Modal
                      const newConnId = Date.now();
                      const newConn = {
                          id: newConnId,
                          fromEquipment: linkSource.toString(), // Ensure string for consistency
                          toEquipment: equipId.toString(),     // Ensure string for consistency
                          labelFrom: '',
                          labelTo: '',
                          fiberType: 'single-mode',
                          length: '',
                          notes: '',
                          createdAt: new Date().toISOString()
                      };
                      
                      setConnections(prev => [...prev, newConn]);
                      logChange('add', 'connection', `Link Mode (${newConn.fromEquipment}->${newConn.toEquipment})`);
                      
                      // Open modal for the new connection immediately
                      setEditingConnection(newConn);
                      
                      // Reset interaction
                      setLinkSource(null); 
                      setLinkMode(false);
                  }
              }
          };

          // --- Import/Export ---
          const exportData = () => {
            const blob = new Blob([JSON.stringify({ rooms, equipment, connections, changeLog }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `network-${Date.now()}.json`; a.click();
          };
          const importData = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const data = JSON.parse(event.target.result);
                setRooms(data.rooms || []); setEquipment(data.equipment || []); setConnections(data.connections || []); setChangeLog(data.changeLog || []);
              };
              reader.readAsText(file);
            }
          };
          const exportDiagram = () => {
             const svg = document.getElementById('network-diagram');
             if(svg) {
                 const url = URL.createObjectURL(new Blob([new XMLSerializer().serializeToString(svg)], { type: 'image/svg+xml' }));
                 const a = document.createElement('a'); a.href = url; a.download = 'diagram.svg'; a.click();
             }
          };

          const getEquipmentName = (id) => equipment.find(e => e.id == id)?.name || 'Unknown';
          const getRoomName = (id) => rooms.find(r => r.id == id)?.name || 'Unknown';

          // --- Diagram Component ---

          const NetworkDiagram = () => {
            
            const { sortedRoomKeys, sortedRoomGroups } = useMemo(() => {
                let roomGroups = {};
                rooms.forEach(r => roomGroups[r.id] = []);
                equipment.forEach(e => { if (roomGroups[e.room]) roomGroups[e.room].push(e); });
                const roomKeys = Object.keys(roomGroups);

                if (autoLayout) {
                    // Simple layout scoring
                    const roomOrder = [...roomKeys];
                    // (Optimization logic omitted for brevity, but functional)
                }
                return { sortedRoomKeys: roomKeys, sortedRoomGroups: roomGroups };
            }, [rooms, equipment, connections, autoLayout]);
            
            const colWidth = 320;
            const width = Math.max(900, sortedRoomKeys.length * colWidth);
            const maxItemsInRoom = Math.max(...Object.values(sortedRoomGroups).map(g => g.length), 0);
            const height = Math.max(600, maxItemsInRoom * 100 + 100);

            // Bundling logic
            const connectionCounts = {};
            connections.forEach(c => {
               const pairKey = [c.fromEquipment, c.toEquipment].sort().join('-');
               connectionCounts[pairKey] = (connectionCounts[pairKey] || 0) + 1;
            });
            const drawnCounts = {};

            const colors = {
                roomBg: '#f1f5f9', roomStroke: '#cbd5e1', roomText: '#334155',
                equipBg: '#ffffff', equipStroke: '#475569', equipText: '#0f172a', 
                fiberSM: '#2563eb', fiberMM: '#f97316', 
            };

            return (
              <div className="bg-white p-4 rounded border shadow-sm">
                <div className="flex justify-between mb-4 items-center">
                  <h3 className="font-bold text-lg text-slate-700">Network Topology</h3>
                  <div className="flex gap-4">
                      <button 
                         onClick={() => { setLinkMode(!linkMode); setLinkSource(null); }}
                         className={`px-3 py-1 rounded flex items-center gap-2 text-sm font-medium border transition-all ${
                             linkMode ? 'bg-green-100 text-green-700 border-green-300 link-mode-active' : 'bg-gray-50 text-gray-600 border-gray-200'
                         }`}
                      >
                          <LinkIcon className="w-4 h-4" /> {linkMode ? (linkSource ? 'Select Destination...' : 'Select Source...') : 'Link Mode'}
                      </button>
                      <button 
                        onClick={() => setAutoLayout(!autoLayout)}
                        className={`px-3 py-1 rounded flex items-center gap-2 text-sm font-medium border ${
                            autoLayout ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-gray-50 text-gray-600 border-gray-200'
                        }`}
                      >
                        <Shuffle className="w-4 h-4" /> {autoLayout ? 'Auto-Layout On' : 'Auto-Layout Off'}
                      </button>
                      <button onClick={exportDiagram} className="px-3 py-1 bg-slate-600 hover:bg-slate-700 text-white rounded flex items-center gap-2 text-sm">
                        <Download className="w-4 h-4" /> SVG
                      </button>
                  </div>
                </div>
                
                {linkMode && (
                    <div className="bg-green-50 text-green-800 px-4 py-2 text-sm rounded mb-2 border border-green-200 flex items-center gap-2">
                        <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        {linkSource ? "Click the Destination equipment." : "Click the Source equipment."}
                        <button onClick={() => setLinkMode(false)} className="ml-auto underline text-xs">Cancel</button>
                    </div>
                )}

                <div className={`overflow-auto border rounded bg-slate-50 relative ${linkMode ? 'link-mode' : ''}`}>
                  <svg id="network-diagram" width={width} height={height} className="block select-none">
                    <defs>
                      <marker id="arrowhead-sm" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill={colors.fiberSM} /></marker>
                      <marker id="arrowhead-mm" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill={colors.fiberMM} /></marker>
                      <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="1" dy="1" stdDeviation="2" floodOpacity="0.1"/></filter>
                    </defs>

                    {sortedRoomKeys.map((roomId, roomIdx) => {
                      const x = roomIdx * colWidth + 50; 
                      const roomEquipment = sortedRoomGroups[roomId];
                      return (
                        <g key={roomId}>
                          <rect x={x} y={40} width={240} height={height - 80} fill={colors.roomBg} stroke={colors.roomStroke} strokeWidth="1" rx="12"/>
                          <text x={x + 120} y={70} textAnchor="middle" fontWeight="bold" fontSize="16" fill={colors.roomText} style={{textTransform: 'uppercase', letterSpacing: '1px'}}>{getRoomName(roomId)}</text>
                          <line x1={x + 20} y1={85} x2={x + 220} y2={85} stroke={colors.roomStroke} strokeWidth="1" />
                          {roomEquipment.map((equip, idx) => {
                            const equipY = 110 + idx * 90; 
                            const isSource = linkSource === equip.id;
                            
                            return (
                              <g key={equip.id} onClick={() => handleEquipmentClick(equip.id)} 
                                 className="cursor-pointer group">
                                <rect x={x + 20} y={equipY} width={200} height={60}
                                      fill={isSource ? '#dcfce7' : colors.equipBg} 
                                      stroke={isSource ? '#16a34a' : colors.equipStroke} 
                                      strokeWidth={isSource ? 3 : 1} rx="6"
                                      filter="url(#shadow)"
                                      className="equipment-box"
                                />
                                <text x={x + 120} y={equipY + 25} textAnchor="middle" fontSize="13" fontWeight="bold" fill={colors.equipText}>{equip.name}</text>
                                <text x={x + 120} y={equipY + 45} textAnchor="middle" fontSize="11" fill="#64748b">{equip.type}</text>
                                <circle cx={x+20} cy={equipY+30} r="3" fill={colors.equipStroke} />
                                <circle cx={x+220} cy={equipY+30} r="3" fill={colors.equipStroke} />
                              </g>
                            );
                          })}
                        </g>
                      );
                    })}
                    
                    {connections.map(conn => {
                      // FIX: Use loose equality (==) here to match String vs Number ID issues
                      const fromEquip = equipment.find(e => e.id == conn.fromEquipment);
                      const toEquip = equipment.find(e => e.id == conn.toEquipment);

                      if (fromEquip && toEquip) {
                        const fromRoomIdx = sortedRoomKeys.indexOf(fromEquip.room);
                        const toRoomIdx = sortedRoomKeys.indexOf(toEquip.room);
                        const fromEquipIdx = sortedRoomGroups[fromEquip.room].indexOf(fromEquip);
                        const toEquipIdx = sortedRoomGroups[toEquip.room].indexOf(toEquip);
                        if (fromEquipIdx === -1 || toEquipIdx === -1) return null;

                        const pairKey = [conn.fromEquipment, conn.toEquipment].sort().join('-');
                        const totalInBundle = connectionCounts[pairKey];
                        const currentIdx = drawnCounts[pairKey] || 0;
                        drawnCounts[pairKey] = currentIdx + 1;
                        const spacing = 15; 
                        const offset = (currentIdx - (totalInBundle - 1) / 2) * spacing;

                        const isMultiMode = conn.fiberType === 'multi-mode';
                        const strokeColor = isMultiMode ? colors.fiberMM : colors.fiberSM;
                        const markerUrl = isMultiMode ? 'url(#arrowhead-mm)' : 'url(#arrowhead-sm)';
                        
                        let pathD = '';
                        let labelX = 0, labelY1 = 0;
                        
                        // Same Room Logic
                        if (fromRoomIdx === toRoomIdx) {
                            const xBase = fromRoomIdx * colWidth + 50 + 220;
                            const y1 = 110 + fromEquipIdx * 90 + 30 + offset;
                            const y2 = 110 + toEquipIdx * 90 + 30 + offset;
                            const curveDepth = 50 + (Math.abs(y1 - y2) * 0.1);
                            const cpX = xBase + curveDepth;
                            pathD = `M ${xBase} ${y1} C ${cpX} ${y1}, ${cpX} ${y2}, ${xBase} ${y2}`;
                            labelX = cpX + 5; labelY1 = y1 + (y2 - y1) * 0.25;
                        } else {
                            // Different Room Logic
                            const x1 = fromRoomIdx * colWidth + 50 + 220; 
                            const y1 = 110 + fromEquipIdx * 90 + 30 + offset;
                            const x2 = toRoomIdx * colWidth + 50 + 20;
                            const y2 = 110 + toEquipIdx * 90 + 30 + offset;
                            const midX = (x1 + x2) / 2;
                            pathD = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                            labelX = x1 + (x2 - x1) * 0.5; labelY1 = y1 + (y2 - y1) * 0.5 - 10;
                        }

                        return (
                          <g key={conn.id} 
                             onClick={(e) => { e.stopPropagation(); setEditingConnection(conn); }}
                             className="group cursor-pointer hover:opacity-100 opacity-90"
                          >
                            <path d={pathD} stroke="transparent" strokeWidth="15" fill="none" />
                            <path d={pathD}
                                  stroke={strokeColor} strokeWidth="2" fill="none" markerEnd={markerUrl}
                                  strokeDasharray={conn.length.includes('km') ? "5,5" : "0"} 
                                  className="group-hover:stroke-[3px] transition-all"
                            />
                            {(conn.labelFrom || conn.labelTo) && (
                                <text x={labelX} y={labelY1} fontSize="10" fill={strokeColor} fontWeight="bold" fontFamily="monospace">
                                    {conn.labelFrom || conn.labelTo}
                                </text>
                            )}
                          </g>
                        );
                      }
                      return null;
                    })}
                  </svg>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-slate-100 p-6 text-slate-800 font-sans">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border border-slate-200">
                  <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center gap-3">
                      <div className="bg-blue-600 p-2 rounded-lg"><Network className="w-8 h-8 text-white" /></div>
                      <h1 className="text-3xl font-bold text-slate-800">Fiber Network Manager</h1>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={exportData} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded shadow-sm flex items-center gap-2"><Download className="w-4 h-4" /> Export JSON</button>
                      <label className="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded shadow-sm flex items-center gap-2 cursor-pointer"><Upload className="w-4 h-4" /> Import<input type="file" accept=".json" onChange={importData} className="hidden" /></label>
                      <button onClick={() => setShowDiagram(!showDiagram)} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded shadow-sm flex items-center gap-2"><Eye className="w-4 h-4" /> {showDiagram ? 'Hide' : 'Show'} Diagram</button>
                    </div>
                  </div>

                  {showDiagram && <NetworkDiagram />}

                  {/* Edit Connection Modal */}
                  <Modal isOpen={!!editingConnection} onClose={() => setEditingConnection(null)} title="Edit Connection">
                      {editingConnection && (
                          <div className="space-y-4">
                              <div className="text-sm text-slate-500 mb-2">
                                  {getEquipmentName(editingConnection.fromEquipment)} → {getEquipmentName(editingConnection.toEquipment)}
                              </div>
                              <div className="grid grid-cols-2 gap-2">
                                  <div>
                                      <label className="text-xs font-bold text-slate-600">Source Label</label>
                                      <input type="text" className="w-full border rounded p-2" 
                                          value={editingConnection.labelFrom} 
                                          onChange={e => setEditingConnection({...editingConnection, labelFrom: e.target.value})} />
                                  </div>
                                  <div>
                                      <label className="text-xs font-bold text-slate-600">Dest Label</label>
                                      <input type="text" className="w-full border rounded p-2" 
                                          value={editingConnection.labelTo} 
                                          onChange={e => setEditingConnection({...editingConnection, labelTo: e.target.value})} />
                                  </div>
                              </div>
                              <div>
                                  <label className="text-xs font-bold text-slate-600">Fiber Type</label>
                                  <select className="w-full border rounded p-2 bg-white"
                                      value={editingConnection.fiberType}
                                      onChange={e => setEditingConnection({...editingConnection, fiberType: e.target.value})}>
                                      <option value="single-mode">Single-mode (Blue)</option>
                                      <option value="multi-mode">Multi-mode (Orange)</option>
                                  </select>
                              </div>
                              <div className="flex gap-2 pt-2">
                                  <button onClick={updateConnection} className="flex-1 bg-blue-600 text-white py-2 rounded flex justify-center items-center gap-2 hover:bg-blue-700">
                                      <Save className="w-4 h-4" /> Save Changes
                                  </button>
                                  <button onClick={() => deleteItem('connection', editingConnection.id, editingConnection.labelFrom)} className="bg-red-100 text-red-600 p-2 rounded hover:bg-red-200">
                                      <Trash2 className="w-5 h-5" />
                                  </button>
                              </div>
                          </div>
                      )}
                  </Modal>

                  <div className="border-b border-slate-200 mb-6">
                    <div className="flex gap-6">
                      {['rooms', 'equipment', 'connections', 'changelog'].map(tab => (
                        <button key={tab} onClick={() => setActiveTab(tab)}
                          className={`px-2 py-3 font-medium transition-colors border-b-2 ${activeTab === tab ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'}`}>
                          {tab.charAt(0).toUpperCase() + tab.slice(1)}
                        </button>
                      ))}
                    </div>
                  </div>

                  {activeTab === 'connections' && (
                    <div className="animate-fade-in">
                       <div className="bg-slate-50 p-5 rounded-lg border border-slate-200 mb-6">
                          <h3 className="font-semibold mb-3 text-slate-700">Add Connection</h3>
                          <div className="grid grid-cols-2 gap-4 mb-3">
                             <div className="flex gap-2">
                               <input type="text" placeholder="Label (Source) - Optional" value={newConnection.labelFrom} onChange={(e) => setNewConnection({ ...newConnection, labelFrom: e.target.value })} className="px-4 py-2 border rounded w-full" />
                               <input type="text" placeholder="Label (Dest) - Optional" value={newConnection.labelTo} onChange={(e) => setNewConnection({ ...newConnection, labelTo: e.target.value })} className="px-4 py-2 border rounded w-full" />
                             </div>
                             <select value={newConnection.fiberType} onChange={(e) => setNewConnection({ ...newConnection, fiberType: e.target.value })} className="px-4 py-2 border rounded bg-white">
                               <option value="single-mode">Single-mode</option><option value="multi-mode">Multi-mode</option>
                             </select>
                             <select value={newConnection.fromEquipment} onChange={(e) => setNewConnection({ ...newConnection, fromEquipment: e.target.value })} className="px-4 py-2 border rounded bg-white">
                               <option value="">From equipment</option>{equipment.map(e => <option key={e.id} value={e.id}>{e.name} ({getRoomName(e.room)})</option>)}
                             </select>
                             <select value={newConnection.toEquipment} onChange={(e) => setNewConnection({ ...newConnection, toEquipment: e.target.value })} className="px-4 py-2 border rounded bg-white">
                               <option value="">To equipment</option>{equipment.map(e => <option key={e.id} value={e.id}>{e.name} ({getRoomName(e.room)})</option>)}
                             </select>
                             <input type="text" placeholder="Length" value={newConnection.length} onChange={(e) => setNewConnection({ ...newConnection, length: e.target.value })} className="px-4 py-2 border rounded" />
                             <input type="text" placeholder="Notes" value={newConnection.notes} onChange={(e) => setNewConnection({ ...newConnection, notes: e.target.value })} className="px-4 py-2 border rounded" />
                          </div>
                          <button onClick={addConnection} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center gap-2"><Plus className="w-4 h-4" /> Add Connection</button>
                       </div>
                       <div className="space-y-2">
                         {connections.map(conn => (
                           <div key={conn.id} className="bg-white border rounded-lg p-4 flex justify-between items-center shadow-sm">
                             <div>
                               <div className="font-bold flex gap-2 items-center">
                                 <span className={`px-2 py-0.5 rounded text-xs text-white uppercase ${conn.fiberType === 'multi-mode' ? 'bg-orange-500' : 'bg-blue-600'}`}>{conn.fiberType === 'multi-mode' ? 'MM' : 'SM'}</span>
                                 {(conn.labelFrom || conn.labelTo) ? <><span className="text-slate-800">{conn.labelFrom}</span><ArrowRightLeft className="w-3 h-3 text-slate-400" /><span className="text-slate-800">{conn.labelTo}</span></> : <span className="text-slate-400 italic font-normal text-sm">Unlabeled</span>}
                               </div>
                               <div className="text-sm text-slate-600 mt-1">{getEquipmentName(conn.fromEquipment)} → {getEquipmentName(conn.toEquipment)}</div>
                             </div>
                             <div className="flex gap-2">
                                <button onClick={() => setEditingConnection(conn)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Eye className="w-4 h-4" /></button>
                                <button onClick={() => deleteItem('connection', conn.id, conn.labelFrom)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>
                             </div>
                           </div>
                         ))}
                       </div>
                    </div>
                  )}

                  {activeTab === 'rooms' && (
                     <div className="animate-fade-in">
                        <div className="bg-slate-50 p-5 rounded-lg border border-slate-200 mb-6">
                           <h3 className="font-semibold mb-3 text-slate-700">Add New Room</h3>
                           <div className="grid grid-cols-2 gap-4 mb-3">
                              <input type="text" placeholder="Room name" value={newRoom.name} onChange={(e) => setNewRoom({ ...newRoom, name: e.target.value })} className="px-4 py-2 border rounded" />
                              <input type="text" placeholder="Description" value={newRoom.description} onChange={(e) => setNewRoom({ ...newRoom, description: e.target.value })} className="px-4 py-2 border rounded" />
                           </div>
                           <button onClick={addRoom} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center gap-2"><Plus className="w-4 h-4" /> Create Room</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                           {rooms.map(room => (
                              <div key={room.id} className="bg-white border rounded-lg p-4 flex justify-between items-center shadow-sm">
                                 <div><div className="font-bold text-lg">{room.name}</div><div className="text-sm text-slate-500">{room.description}</div></div>
                                 <button onClick={() => deleteItem('room', room.id, room.name)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>
                              </div>
                           ))}
                        </div>
                     </div>
                  )}

                  {activeTab === 'equipment' && (
                     <div className="animate-fade-in">
                        <div className="bg-slate-50 p-5 rounded-lg border border-slate-200 mb-6">
                           <h3 className="font-semibold mb-3 text-slate-700">Add Equipment</h3>
                           <div className="grid grid-cols-2 gap-4 mb-3">
                              <input type="text" placeholder="Name" value={newEquipment.name} onChange={(e) => setNewEquipment({ ...newEquipment, name: e.target.value })} className="px-4 py-2 border rounded" />
                              <select value={newEquipment.type} onChange={(e) => setNewEquipment({ ...newEquipment, type: e.target.value })} className="px-4 py-2 border rounded bg-white">{equipmentTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                              <select value={newEquipment.room} onChange={(e) => setNewEquipment({ ...newEquipment, room: e.target.value })} className="px-4 py-2 border rounded bg-white"><option value="">Select room</option>{rooms.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select>
                              <input type="text" placeholder="Description" value={newEquipment.description} onChange={(e) => setNewEquipment({ ...newEquipment, description: e.target.value })} className="px-4 py-2 border rounded" />
                           </div>
                           <button onClick={addEquipment} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center gap-2"><Plus className="w-4 h-4" /> Add Equipment</button>
                        </div>
                        <div className="space-y-2">
                           {equipment.map(equip => (
                              <div key={equip.id} className="bg-white border rounded-lg p-4 flex justify-between items-center shadow-sm">
                                 <div><div className="font-bold">{equip.name}</div><div className="text-sm text-slate-500">{equip.type} in {getRoomName(equip.room)}</div></div>
                                 <button onClick={() => deleteItem('equipment', equip.id, equip.name)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>
                              </div>
                           ))}
                        </div>
                     </div>
                  )}

                  {activeTab === 'changelog' && (
                    <div className="animate-fade-in">
                      <h2 className="text-xl font-bold mb-4 text-slate-800">Change Log</h2>
                      <div className="space-y-2">
                        {changeLog.map(log => (
                          <div key={log.id} className="bg-white border rounded-lg p-3 text-sm">
                            <div className="flex justify-between">
                              <div><span className={`font-bold capitalize ${log.action === 'add' ? 'text-green-600' : (log.action === 'delete' ? 'text-red-600' : 'text-blue-600')}`}>{log.action.toUpperCase()}</span> <span className="mx-2 text-slate-300">|</span> <span className="text-slate-700 font-medium">{log.type}</span> <span className="mx-2 text-slate-300">|</span> <span className="text-slate-600">{log.item}</span></div>
                              <div className="text-slate-400 text-xs">{new Date(log.timestamp).toLocaleString()}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FiberNetworkManager />);

    </script>
</body>
</html>
