<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiber Network Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Trash2, Download, Save, Upload, Network, Eye } from 'lucide-react';

        const FiberNetworkManager = () => {
          const [rooms, setRooms] = useState([]);
          const [equipment, setEquipment] = useState([]);
          const [connections, setConnections] = useState([]);
          const [changeLog, setChangeLog] = useState([]);
          const [activeTab, setActiveTab] = useState('rooms');
          const [showDiagram, setShowDiagram] = useState(false);

          // Form states
          const [newRoom, setNewRoom] = useState({ name: '', description: '' });
          const [newEquipment, setNewEquipment] = useState({ 
            name: '', 
            type: 'laser', 
            room: '', 
            description: '' 
          });
          
          // UPDATED: Split label into labelFrom and labelTo
          const [newConnection, setNewConnection] = useState({
            labelFrom: '',
            labelTo: '',
            fromEquipment: '',
            toEquipment: '',
            fiberType: 'single-mode',
            length: '',
            notes: ''
          });

          const equipmentTypes = [
            'laser', 'multiplexer', 'amplifier', 'white-rabbit', 
            'connection-box', 'splitter', 'user-device', 'other'
          ];

          const addRoom = () => {
            if (newRoom.name.trim()) {
              const room = { id: Date.now(), ...newRoom, createdAt: new Date().toISOString() };
              setRooms([...rooms, room]);
              logChange('add', 'room', room.name);
              setNewRoom({ name: '', description: '' });
            }
          };

          const addEquipment = () => {
            if (newEquipment.name.trim() && newEquipment.room) {
              const equip = { id: Date.now(), ...newEquipment, createdAt: new Date().toISOString() };
              setEquipment([...equipment, equip]);
              logChange('add', 'equipment', equip.name);
              setNewEquipment({ name: '', type: 'laser', room: '', description: '' });
            }
          };

          const addConnection = () => {
            // UPDATED: Check both labels
            if ((newConnection.labelFrom.trim() || newConnection.labelTo.trim()) && newConnection.fromEquipment && newConnection.toEquipment) {
              const conn = { id: Date.now(), ...newConnection, createdAt: new Date().toISOString() };
              setConnections([...connections, conn]);
              logChange('add', 'connection', `${newConnection.labelFrom}->${newConnection.labelTo}`);
              setNewConnection({
                labelFrom: '',
                labelTo: '',
                fromEquipment: '',
                toEquipment: '',
                fiberType: 'single-mode',
                length: '',
                notes: ''
              });
            }
          };

          const deleteItem = (type, id, name) => {
            if (type === 'room') {
              setRooms(rooms.filter(r => r.id !== id));
              setEquipment(equipment.filter(e => e.room !== id.toString()));
            } else if (type === 'equipment') {
              setEquipment(equipment.filter(e => e.id !== id));
              setConnections(connections.filter(c => 
                c.fromEquipment !== id.toString() && c.toEquipment !== id.toString()
              ));
            } else if (type === 'connection') {
              setConnections(connections.filter(c => c.id !== id));
            }
            logChange('delete', type, name);
          };

          const logChange = (action, type, item) => {
            const log = {
              id: Date.now(),
              timestamp: new Date().toISOString(),
              action,
              type,
              item
            };
            setChangeLog([log, ...changeLog]);
          };

          const exportData = () => {
            const data = {
              rooms,
              equipment,
              connections,
              changeLog,
              exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fiber-network-${Date.now()}.json`;
            a.click();
          };

          const importData = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                try {
                  const data = JSON.parse(event.target.result);
                  setRooms(data.rooms || []);
                  setEquipment(data.equipment || []);
                  setConnections(data.connections || []);
                  setChangeLog(data.changeLog || []);
                  logChange('import', 'data', 'Full network data');
                } catch (error) {
                  alert('Error importing file');
                }
              };
              reader.readAsText(file);
            }
          };

          const exportDiagram = () => {
            const svg = document.getElementById('network-diagram');
            if (svg) {
              const svgData = new XMLSerializer().serializeToString(svg);
              const blob = new Blob([svgData], { type: 'image/svg+xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `fiber-diagram-${Date.now()}.svg`;
              a.click();
            }
          };

          const getEquipmentName = (id) => {
            const equip = equipment.find(e => e.id.toString() === id);
            return equip ? equip.name : 'Unknown';
          };

          const getRoomName = (id) => {
            const room = rooms.find(r => r.id.toString() === id);
            return room ? room.name : 'Unknown';
          };

          const NetworkDiagram = () => {
            const roomGroups = {};
            equipment.forEach(e => {
              if (!roomGroups[e.room]) roomGroups[e.room] = [];
              roomGroups[e.room].push(e);
            });

            const roomKeys = Object.keys(roomGroups);
            const width = Math.max(800, roomKeys.length * 300); // Increased width slightly
            const height = 600;

            return (
              <div className="bg-white p-4 rounded border">
                <div className="flex justify-between mb-4">
                  <h3 className="font-bold text-lg">Network Diagram</h3>
                  <button onClick={exportDiagram} className="px-3 py-1 bg-blue-600 text-white rounded flex items-center gap-2">
                    <Download className="w-4 h-4" /> Export SVG
                  </button>
                </div>
                <div className="overflow-auto border rounded">
                  <svg id="network-diagram" width={width} height={height} className="bg-gray-50">
                    {roomKeys.map((roomId, roomIdx) => {
                      const x = roomIdx * 300 + 50; // Increased spacing
                      const roomEquipment = roomGroups[roomId];
                      
                      return (
                        <g key={roomId}>
                          <rect x={x} y={20} width={220} height={height - 40} 
                                fill="#e0f2fe" stroke="#0284c7" strokeWidth="2" rx="8"/>
                          <text x={x + 110} y={45} textAnchor="middle" 
                                fontWeight="bold" fontSize="14" fill="#0c4a6e">
                            {getRoomName(roomId)}
                          </text>
                          
                          {roomEquipment.map((equip, idx) => {
                            const equipY = 70 + idx * 70;
                            const equipX = x + 110;
                            
                            return (
                              <g key={equip.id}>
                                <rect x={x + 20} y={equipY} width={180} height={50}
                                      fill="#fff" stroke="#0284c7" strokeWidth="1.5" rx="4"/>
                                <text x={equipX} y={equipY + 20} textAnchor="middle" 
                                      fontSize="12" fontWeight="bold" fill="#0c4a6e">
                                  {equip.name}
                                </text>
                                <text x={equipX} y={equipY + 38} textAnchor="middle" 
                                      fontSize="10" fill="#64748b">
                                  {equip.type}
                                </text>
                              </g>
                            );
                          })}
                        </g>
                      );
                    })}
                    
                    {connections.map(conn => {
                      const fromEquip = equipment.find(e => e.id.toString() === conn.fromEquipment);
                      const toEquip = equipment.find(e => e.id.toString() === conn.toEquipment);
                      
                      if (fromEquip && toEquip) {
                        const fromRoomIdx = roomKeys.indexOf(fromEquip.room);
                        const toRoomIdx = roomKeys.indexOf(toEquip.room);
                        const fromEquipIdx = roomGroups[fromEquip.room].indexOf(fromEquip);
                        const toEquipIdx = roomGroups[toEquip.room].indexOf(toEquip);
                        
                        // Calculate coordinates
                        // x1 is right edge of Source Box
                        const x1 = fromRoomIdx * 300 + 50 + 200; 
                        const y1 = 70 + fromEquipIdx * 70 + 25;
                        
                        // x2 is left edge of Dest Box
                        const x2 = toRoomIdx * 300 + 50 + 20;
                        const y2 = 70 + toEquipIdx * 70 + 25;
                        
                        const midX = (x1 + x2) / 2;
                        
                        // UPDATED: Calculate label positions
                        // Position Source Label 15% along the path from source
                        const labelX1 = x1 + (x2 - x1) * 0.15;
                        const labelY1 = y1; 

                        // Position Dest Label 85% along the path from source (or 15% from dest)
                        const labelX2 = x1 + (x2 - x1) * 0.85;
                        const labelY2 = y2;
                        
                        // Determine text anchor based on direction
                        const isLeftToRight = x2 > x1;

                        return (
                          <g key={conn.id}>
                            <path d={`M ${x1} ${y1} Q ${midX} ${y1}, ${midX} ${(y1 + y2) / 2} Q ${midX} ${y2}, ${x2} ${y2}`}
                                  stroke="#f97316" strokeWidth="2" fill="none" markerEnd="url(#arrowhead)"/>
                            
                            {/* Source Label */}
                            <text x={labelX1} y={labelY1 - 5} 
                                  textAnchor={isLeftToRight ? "start" : "end"} 
                                  fontSize="10" fill="#ea580c" fontWeight="bold">
                              {conn.labelFrom}
                            </text>

                             {/* Dest Label */}
                             <text x={labelX2} y={labelY2 - 5} 
                                  textAnchor={isLeftToRight ? "end" : "start"} 
                                  fontSize="10" fill="#ea580c" fontWeight="bold">
                              {conn.labelTo}
                            </text>
                          </g>
                        );
                      }
                      return null;
                    })}
                    
                    <defs>
                      <marker id="arrowhead" markerWidth="10" markerHeight="10" 
                              refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#f97316" />
                      </marker>
                    </defs>
                  </svg>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-100 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-3">
                      <Network className="w-8 h-8 text-blue-600" />
                      <h1 className="text-3xl font-bold text-gray-800">Fiber Network Manager</h1>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={exportData} className="px-4 py-2 bg-green-600 text-white rounded flex items-center gap-2">
                        <Download className="w-4 h-4" /> Export
                      </button>
                      <label className="px-4 py-2 bg-blue-600 text-white rounded flex items-center gap-2 cursor-pointer">
                        <Upload className="w-4 h-4" /> Import
                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                      </label>
                      <button 
                        onClick={() => setShowDiagram(!showDiagram)} 
                        className="px-4 py-2 bg-purple-600 text-white rounded flex items-center gap-2">
                        <Eye className="w-4 h-4" /> {showDiagram ? 'Hide' : 'Show'} Diagram
                      </button>
                    </div>
                  </div>

                  {showDiagram && <NetworkDiagram />}

                  <div className="border-b mb-4">
                    <div className="flex gap-4">
                      {['rooms', 'equipment', 'connections', 'changelog'].map(tab => (
                        <button
                          key={tab}
                          onClick={() => setActiveTab(tab)}
                          className={`px-4 py-2 font-medium ${
                            activeTab === tab
                              ? 'border-b-2 border-blue-600 text-blue-600'
                              : 'text-gray-600 hover:text-gray-800'
                          }`}
                        >
                          {tab.charAt(0).toUpperCase() + tab.slice(1)}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* ROOMS TAB */}
                  {activeTab === 'rooms' && (
                    <div>
                      <h2 className="text-xl font-bold mb-4">Rooms</h2>
                      <div className="bg-gray-50 p-4 rounded mb-4">
                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <input
                            type="text"
                            placeholder="Room name"
                            value={newRoom.name}
                            onChange={(e) => setNewRoom({ ...newRoom, name: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                          <input
                            type="text"
                            placeholder="Description"
                            value={newRoom.description}
                            onChange={(e) => setNewRoom({ ...newRoom, description: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                        </div>
                        <button onClick={addRoom} className="px-4 py-2 bg-blue-600 text-white rounded flex items-center gap-2">
                          <Plus className="w-4 h-4" /> Add Room
                        </button>
                      </div>
                      <div className="space-y-2">
                        {rooms.map(room => (
                          <div key={room.id} className="bg-white border rounded p-3 flex justify-between items-center">
                            <div>
                              <div className="font-bold">{room.name}</div>
                              <div className="text-sm text-gray-600">{room.description}</div>
                            </div>
                            <button onClick={() => deleteItem('room', room.id, room.name)} 
                                    className="text-red-600 hover:bg-red-50 p-2 rounded">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* EQUIPMENT TAB */}
                  {activeTab === 'equipment' && (
                    <div>
                      <h2 className="text-xl font-bold mb-4">Equipment</h2>
                      <div className="bg-gray-50 p-4 rounded mb-4">
                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <input
                            type="text"
                            placeholder="Equipment name"
                            value={newEquipment.name}
                            onChange={(e) => setNewEquipment({ ...newEquipment, name: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                          <select
                            value={newEquipment.type}
                            onChange={(e) => setNewEquipment({ ...newEquipment, type: e.target.value })}
                            className="px-3 py-2 border rounded"
                          >
                            {equipmentTypes.map(type => (
                              <option key={type} value={type}>{type}</option>
                            ))}
                          </select>
                          <select
                            value={newEquipment.room}
                            onChange={(e) => setNewEquipment({ ...newEquipment, room: e.target.value })}
                            className="px-3 py-2 border rounded"
                          >
                            <option value="">Select room</option>
                            {rooms.map(room => (
                              <option key={room.id} value={room.id}>{room.name}</option>
                            ))}
                          </select>
                          <input
                            type="text"
                            placeholder="Description"
                            value={newEquipment.description}
                            onChange={(e) => setNewEquipment({ ...newEquipment, description: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                        </div>
                        <button onClick={addEquipment} className="px-4 py-2 bg-blue-600 text-white rounded flex items-center gap-2">
                          <Plus className="w-4 h-4" /> Add Equipment
                        </button>
                      </div>
                      <div className="space-y-2">
                        {equipment.map(equip => (
                          <div key={equip.id} className="bg-white border rounded p-3 flex justify-between items-center">
                            <div>
                              <div className="font-bold">{equip.name}</div>
                              <div className="text-sm text-gray-600">
                                {equip.type} • {getRoomName(equip.room)} • {equip.description}
                              </div>
                            </div>
                            <button onClick={() => deleteItem('equipment', equip.id, equip.name)} 
                                    className="text-red-600 hover:bg-red-50 p-2 rounded">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* CONNECTIONS TAB */}
                  {activeTab === 'connections' && (
                    <div>
                      <h2 className="text-xl font-bold mb-4">Fiber Connections</h2>
                      <div className="bg-gray-50 p-4 rounded mb-4">
                        <div className="grid grid-cols-2 gap-4 mb-3">
                          
                          {/* UPDATED: Split inputs for Source and Dest labels */}
                          <div className="flex gap-2">
                             <input
                              type="text"
                              placeholder="Label (Source)"
                              value={newConnection.labelFrom}
                              onChange={(e) => setNewConnection({ ...newConnection, labelFrom: e.target.value })}
                              className="px-3 py-2 border rounded w-full"
                            />
                            <input
                              type="text"
                              placeholder="Label (Dest)"
                              value={newConnection.labelTo}
                              onChange={(e) => setNewConnection({ ...newConnection, labelTo: e.target.value })}
                              className="px-3 py-2 border rounded w-full"
                            />
                          </div>

                          <select
                            value={newConnection.fiberType}
                            onChange={(e) => setNewConnection({ ...newConnection, fiberType: e.target.value })}
                            className="px-3 py-2 border rounded"
                          >
                            <option value="single-mode">Single-mode</option>
                            <option value="multi-mode">Multi-mode</option>
                          </select>
                          <select
                            value={newConnection.fromEquipment}
                            onChange={(e) => setNewConnection({ ...newConnection, fromEquipment: e.target.value })}
                            className="px-3 py-2 border rounded"
                          >
                            <option value="">From equipment</option>
                            {equipment.map(equip => (
                              <option key={equip.id} value={equip.id}>
                                {equip.name} ({getRoomName(equip.room)})
                              </option>
                            ))}
                          </select>
                          <select
                            value={newConnection.toEquipment}
                            onChange={(e) => setNewConnection({ ...newConnection, toEquipment: e.target.value })}
                            className="px-3 py-2 border rounded"
                          >
                            <option value="">To equipment</option>
                            {equipment.map(equip => (
                              <option key={equip.id} value={equip.id}>
                                {equip.name} ({getRoomName(equip.room)})
                              </option>
                            ))}
                          </select>
                          <input
                            type="text"
                            placeholder="Length (e.g., 50m)"
                            value={newConnection.length}
                            onChange={(e) => setNewConnection({ ...newConnection, length: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                          <input
                            type="text"
                            placeholder="Notes"
                            value={newConnection.notes}
                            onChange={(e) => setNewConnection({ ...newConnection, notes: e.target.value })}
                            className="px-3 py-2 border rounded"
                          />
                        </div>
                        <button onClick={addConnection} className="px-4 py-2 bg-blue-600 text-white rounded flex items-center gap-2">
                          <Plus className="w-4 h-4" /> Add Connection
                        </button>
                      </div>
                      <div className="space-y-2">
                        {connections.map(conn => (
                          <div key={conn.id} className="bg-white border rounded p-3 flex justify-between items-center">
                            <div>
                              {/* UPDATED: Display both labels */}
                              <div className="font-bold text-orange-600 flex gap-2 items-center">
                                <span>{conn.labelFrom || conn.label}</span>
                                <span className="text-gray-400 text-sm">→</span>
                                <span>{conn.labelTo || conn.label}</span>
                              </div>
                              <div className="text-sm text-gray-600">
                                {getEquipmentName(conn.fromEquipment)} → {getEquipmentName(conn.toEquipment)}
                              </div>
                              <div className="text-sm text-gray-500">
                                {conn.fiberType} • {conn.length} • {conn.notes}
                              </div>
                            </div>
                            <button onClick={() => deleteItem('connection', conn.id, conn.labelFrom)} 
                                    className="text-red-600 hover:bg-red-50 p-2 rounded">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* CHANGELOG TAB */}
                  {activeTab === 'changelog' && (
                    <div>
                      <h2 className="text-xl font-bold mb-4">Change Log</h2>
                      <div className="space-y-2">
                        {changeLog.map(log => (
                          <div key={log.id} className="bg-white border rounded p-3">
                            <div className="flex justify-between">
                              <div>
                                <span className="font-bold capitalize">{log.action}</span>
                                <span className="mx-2">•</span>
                                <span className="text-gray-600">{log.type}</span>
                                <span className="mx-2">•</span>
                                <span>{log.item}</span>
                              </div>
                              <div className="text-sm text-gray-500">
                                {new Date(log.timestamp).toLocaleString()}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FiberNetworkManager />);

    </script>
</body>
</html>
